from flask_sqlalchemy import SQLAlchemy
from flask_cors import CORS
from flask_migrate import Migrate
from datetime import datetime
import random
import os

app = Flask(__name__)
CORS(app, resources={r"/*": {"origins": "*"}})

# Configuring the SQLAlchemy Database URI and initializing the database
app.config['SQLALCHEMY_DATABASE_URI'] = 'postgresql://postgres.ggxkqovbruyvfhdfkasw:dk22POZZTvc4HC4W@aws-0-eu-central-1.pooler.supabase.com:6543/postgres'
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False

db = SQLAlchemy(app)
migrate = Migrate(app, db)  # Initialize Flask-Migrate

# Define the User model
class User(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    telegram_id = db.Column(db.String(100), nullable=False, unique=True)

# Define the Channel model
class Channel(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(100), nullable=True)  # Optional for public channels
    chat_id = db.Column(db.BigInteger, nullable=True)  # Required for private channels
    user_id = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False)

# Define the Giveaway model
class Giveaway(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(100), nullable=False)
    prize_amount = db.Column(db.Float, nullable=False)
    participants_count = db.Column(db.Integer, nullable=False)
    end_date = db.Column(db.DateTime, nullable=False)
    channel_id = db.Column(db.Integer, db.ForeignKey('channel.id'), nullable=False)
    user_id = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False)
    announced = db.Column(db.Boolean, default=False)

# Define the Participant model
class Participant(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False)
    giveaway_id = db.Column(db.Integer, db.ForeignKey('giveaway.id'), nullable=False)

# Define the Notification model
class Notification(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False)
    message = db.Column(db.String(500), nullable=False)
    type = db.Column(db.String(50), nullable=False)  # 'participant' or 'winner'
    sent = db.Column(db.Boolean, default=False)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)

# Define the Winner model
class Winner(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    giveaway_id = db.Column(db.Integer, db.ForeignKey('giveaway.id'), nullable=False)
    user_id = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)

# Utility function to add a notification
def add_notification(user_id, message, notif_type):
    notification = Notification(
        user_id=user_id,
        message=message,
        type=notif_type
    )
    db.session.add(notification)
    db.session.commit()

# Endpoint to initialize a user
@app.route('/init_user', methods=['POST'])
def init_user():
    try:
        data = request.get_json()
        telegram_id = data.get('telegram_id')

        if not telegram_id:
            return jsonify({'success': False, 'message': 'Missing telegram_id'}), 400

        user = User.query.filter_by(telegram_id=telegram_id).first()
        if not user:
            user = User(telegram_id=telegram_id)
            db.session.add(user)
            db.session.commit()

        return jsonify({'success': True, 'user_id': user.id})
    except Exception as e:
        return jsonify({'success': False, 'message': str(e)}), 500

# Endpoint to add a channel
@app.route('/add_channel', methods=['POST'])
def add_channel():
    try:
        data = request.get_json()
        username = data.get('username')
        chat_id = data.get('chat_id')  # Numeric chat_id
        user_id = data.get('user_id')

        if not user_id:
            return jsonify({'success': False, 'message': 'Missing user_id'}), 400

        existing_channel = Channel.query.filter_by(chat_id=chat_id, user_id=user_id).first()
        if existing_channel:
            return jsonify({'success': False, 'message': 'Channel already exists.'}), 400

        channel = Channel(username=username, chat_id=chat_id, user_id=user_id)
        db.session.add(channel)
        db.session.commit()

        return jsonify({'success': True, 'message': 'Channel added successfully!'})
    except Exception as e:
        return jsonify({'success': False, 'message': str(e)}), 500

# Endpoint to get channels for a specific user
@app.route('/get_user_channels', methods=['GET'])
def get_user_channels():
    try:
        user_id = request.args.get('user_id')

        if not user_id:
            return jsonify({'success': False, 'message': 'Missing user_id parameter'}), 400

        channels = Channel.query.filter_by(user_id=user_id).all()
        if not channels:
            return jsonify({'success': False, 'message': 'No channels found.'}), 404

        channel_list = [{'id': channel.id, 'username': channel.username} for channel in channels]
        return jsonify({'success': True, 'channels': channel_list})
    except Exception as e:
        return jsonify({'success': False, 'message': str(e)}), 500

# Endpoint to create a giveaway
@app.route('/create_giveaway', methods=['POST'])
def create_giveaway():
    try:
        data = request.get_json()

        name = data.get('name')
        prize_amount = data.get('prize_amount')
        participants_count = data.get('participants_count')
        end_date = data.get('end_date')
        channel_id = data.get('channel_id')
        user_id = data.get('user_id')

        if not all([name, prize_amount, participants_count, end_date, channel_id, user_id]):
            return jsonify({'success': False, 'message': 'Missing required fields'}), 400

        giveaway = Giveaway(
            name=name, 
            prize_amount=prize_amount, 
            participants_count=participants_count,
            end_date=end_date, 
            channel_id=channel_id, 
            user_id=user_id,
            announced=False
        )
        
        db.session.add(giveaway)
        db.session.commit()

        return jsonify({'success': True, 'message': 'Giveaway created successfully!'})
    except Exception as e:
        return jsonify({'success': False, 'message': str(e)}), 500

# Endpoint to join a giveaway
@app.route('/join_giveaway', methods=['POST'])
def join_giveaway():
    try:
        data = request.get_json()
        telegram_id = data.get('telegram_id')
        giveaway_id = data.get('giveaway_id')

        if not telegram_id or not giveaway_id:
            return jsonify({'success': False, 'message': 'Missing telegram_id or giveaway_id'}), 400

        user = User.query.filter_by(telegram_id=telegram_id).first()
        if not user:
            return jsonify({'success': False, 'message': 'User not found'}), 404

        participant = Participant.query.filter_by(user_id=user.id, giveaway_id=giveaway_id).first()
        if participant:
            return jsonify({'success': False, 'message': 'Already joined this giveaway'}), 400

        participant = Participant(user_id=user.id, giveaway_id=giveaway_id)
        db.session.add(participant)
        db.session.commit()

        add_notification(user.id, f"You have successfully joined the giveaway: {Giveaway.query.get(giveaway_id).name}", 'participant')

        return jsonify({'success': True, 'message': 'Successfully joined the giveaway!'})
    except Exception as e:
        return jsonify({'success': False, 'message': str(e)}), 500

# Function to select winners
def select_winners(giveaway_id, number_of_winners):
    giveaway = Giveaway.query.get(giveaway_id)
    if not giveaway:
        return {"error": "Giveaway not found"}

    participants = Participant.query.filter_by(giveaway_id=giveaway_id).all()
    if len(participants) < number_of_winners:
        return {"error": "Not enough participants"}

    selected_winners = random.sample(participants, number_of_winners)
    winner_ids = []

    for participant in selected_winners:
        winner = Winner(giveaway_id=giveaway.id, user_id=participant.user_id)
        db.session.add(winner)
        winner_ids.append(participant.user_id)

        # Add a notification for the winner
        add_notification(participant.user_id, f"Congratulations! You have won the giveaway: {giveaway.name}", 'winner')

    db.session.commit()
    return {"success": True, "winner_ids": winner_ids}

# Endpoint to get winners of a giveaway
@app.route('/api/giveaway/<int:giveaway_id>/winners', methods=['GET'])
def get_winners(giveaway_id):
    try:
        giveaway = Giveaway.query.get(giveaway_id)
        if not giveaway:
            return jsonify({'success': False, 'message': 'Giveaway not found'}), 404

        winners = Winner.query.filter_by(giveaway_id=giveaway_id).all()
        winner_list = [{'id': winner.id, 'user_id': winner.user_id, 'giveaway_id': winner.giveaway_id} for winner in winners]

        return jsonify({'success': True, 'winners': winner_list})
    except Exception as e:
        return jsonify({'success': False, 'message': str(e)}), 500

# Function to send scheduled notifications for ending giveaways
def check_and_send_notifications():
    giveaways = Giveaway.query.filter(Giveaway.end_date <= datetime.utcnow(), Giveaway.announced == False).all()

    for giveaway in giveaways:
        select_winners(giveaway.id, 1)
        giveaway.announced = True
        db.session.commit()

# Endpoint to fetch user notifications
@app.route('/user_notifications', methods=['GET'])
def user_notifications():
    try:
        user_id = request.args.get('user_id')

        if not user_id:
            return jsonify({'success': False, 'message': 'Missing user_id parameter'}), 400

        notifications = Notification.query.filter_by(user_id=user_id).order_by(Notification.created_at.desc()).all()

        notification_list = [{'id': notif.id, 'message': notif.message, 'type': notif.type, 'sent': notif.sent} for notif in notifications]

        return jsonify({'success': True, 'notifications': notification_list})
    except Exception as e:
        return jsonify({'success': False, 'message': str(e)}), 500

if __name__ == '__main__':
    app.run(debug=True)  
And the bot.py( which read the database and interact with users and channels on telegram): import logging
import asyncio
from datetime import datetime
from telegram import Update
from telegram.ext import Application, CommandHandler, ContextTypes
from sqlalchemy import create_engine, Column, Integer, String, Float, Boolean, DateTime, ForeignKey, BigInteger
from sqlalchemy.orm import sessionmaker, scoped_session
from sqlalchemy.ext.declarative import declarative_base


# Constants
TELEGRAM_BOT_TOKEN = '7514207604:AAE_p_eFFQ3yOoNn-GSvTSjte2l8UEHl7b8'
DATABASE_URI = 'postgresql://postgres.ggxkqovbruyvfhdfkasw:dk22POZZTvc4HC4W@aws-0-eu-central-1.pooler.supabase.com:6543/postgres'


# Setup logging
logging.basicConfig(format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.INFO)
logger = logging.getLogger(__name__)

# Setup SQLAlchemy
engine = create_engine(DATABASE_URI)
Session = scoped_session(sessionmaker(bind=engine))
Base = declarative_base()

# Define models
class User(Base):
    __tablename__ = 'user'
    id = Column(Integer, primary_key=True)
    telegram_id = Column(String(100), nullable=False, unique=True)

class Channel(Base):
    __tablename__ = 'channel'
    id = Column(Integer, primary_key=True)
    username = Column(String(100), nullable=True)
    chat_id = Column(BigInteger, nullable=True)
    user_id = Column(Integer, ForeignKey('user.id'), nullable=False)

class Giveaway(Base):
    __tablename__ = 'giveaway'
    id = Column(Integer, primary_key=True)
    name = Column(String(100), nullable=False)
    prize_amount = Column(Float, nullable=False)
    participants_count = Column(Integer, nullable=False)
    end_date = Column(DateTime, nullable=False)
    channel_id = Column(Integer, ForeignKey('channel.id'), nullable=False)
    user_id = Column(Integer, ForeignKey('user.id'), nullable=False)
    announced = Column(Boolean, default=False)

class Participant(Base):
    __tablename__ = 'participant'
    id = Column(Integer, primary_key=True)
    telegram_id = Column(String(100), nullable=False)
    giveaway_id = Column(Integer, ForeignKey('giveaway.id'), nullable=False)

class Notification(Base):
    __tablename__ = 'notification'
    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, nullable=False)
    message = Column(String(500), nullable=False)
    type = Column(String(50), nullable=False)
    sent = Column(Boolean, default=False)
    created_at = Column(DateTime, default=datetime.utcnow)

class Winner(Base):
    __tablename__ = 'winner'
    id = Column(Integer, primary_key=True)
    giveaway_id = Column(Integer, ForeignKey('giveaway.id'), nullable=False)
    user_id = Column(Integer, ForeignKey('user.id'), nullable=False)
    created_at = Column(DateTime, default=datetime.utcnow)

# Helper function to get a new session
def get_session():
    return Session()

# Function to announce new giveaways
async def announce_new_giveaways(application: Application):
    session = get_session()
    try:
        new_giveaways = session.query(Giveaway).filter_by(announced=False).all()
        for giveaway in new_giveaways:
            channel = session.query(Channel).filter_by(id=giveaway.channel_id).first()

            if channel:
                chat_id = channel.chat_id
                if not chat_id and channel.username:
                    try:
                        chat = await application.bot.get_chat(channel.username)
                        chat_id = chat.id
                    except Exception as e:
                        logger.error(f"Error resolving chat_id for channel {channel.username}: {str(e)}")
                        continue

                if chat_id:
                    message = (
                        f"🎉 New Giveaway Alert! 🎉\n\n"
                        f"Name: {giveaway.name}\n"
                        f"Prize: ${giveaway.prize_amount}\n"
                        f"Number of Participants: {giveaway.participants_count}\n"
                        f"Ends on: {giveaway.end_date}\n\n"
                        f"Join the giveaway here: "
                        f"https://t.me/giveaway_setota_bot/Join_Giveaway?giveaway_id={giveaway.id}"
                    )
                    await application.bot.send_message(chat_id=chat_id, text=message)

                    
                else:
                    logger.error(f"No valid chat_id or username for channel ID {channel.id}")

    except Exception as e:
        logger.error(f"Error announcing new giveaways: {str(e)}")
    finally:
        session.remove()

# Function to announce winners privately
async def announce_winners(application: Application):
    session = get_session()
    try:
        winners = session.query(Winner).all()
        for winner in winners:
            giveaway = session.query(Giveaway).filter_by(id=winner.giveaway_id).first()
            user = session.query(User).filter_by(id=winner.user_id).first()

            if not giveaway.announced:
                message = (
                    f"🎉 Congratulations @{user.telegram_id}!\n"
                    f"You've won the giveaway '{giveaway.name}' with a prize of ${giveaway.prize_amount}!"
                )
                await application.bot.send_message(chat_id=user.telegram_id, text=message)
                giveaway.announced = True
                session.commit()

    except Exception as e:
        logger.error(f"Error announcing winners: {str(e)}")
    finally:
        session.remove()

# Function to check the database for changes
async def check_database(application: Application):
    await announce_new_giveaways(application)
    await announce_winners(application)

# Command: Start - to initialize the user
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    telegram_id = update.message.from_user.username
    session = get_session()
    try:
        user = session.query(User).filter_by(telegram_id=telegram_id).first()
        if not user:
            user = User(telegram_id=telegram_id)
            session.add(user)
            session.commit()
        await update.message.reply_text(f"Welcome @{telegram_id}! You are now registered in our giveaway system.")
    finally:
        session.remove()

# Command: Join - to join a giveaway
async def join_giveaway(update: Update, context: ContextTypes.DEFAULT_TYPE):
    telegram_id = update.message.from_user.username
    giveaway_id = int(context.args[0])
    session = get_session()
    try:
        user = session.query(User).filter_by(telegram_id=telegram_id).first()
        giveaway = session.query(Giveaway).filter_by(id=giveaway_id).first()
        if not user:
            await update.message.reply_text("You need to /start first to register.")
            return
        if not giveaway:
            await update.message.reply_text("This giveaway does not exist.")
            return
        participant = session.query(Participant).filter_by(telegram_id=telegram_id, giveaway_id=giveaway_id).first()
        if participant:
            await update.message.reply_text("You have already joined this giveaway.")
            return
        participant = Participant(telegram_id=telegram_id, giveaway_id=giveaway_id)
        session.add(participant)
        session.commit()
        notification_message = f"You have successfully joined the giveaway '{giveaway.name}'!"
        notification = Notification(user_id=user.id, message=notification_message, type='participant')
        session.add(notification)
        session.commit()
        await update.message.reply_text(notification_message)
    finally:
        session.remove()

# Command: Notifications - to check user notifications
async def user_notifications(update: Update, context: ContextTypes.DEFAULT_TYPE):
    telegram_id = update.message.from_user.username
    session = get_session()
    try:
        user = session.query(User).filter_by(telegram_id=telegram_id).first()
        if not user:
            await update.message.reply_text("You need to /start first to register.")
            return
        notifications = session.query(Notification).filter_by(user_id=user.id, sent=False).all()
        if notifications:
            for notification in notifications:
                await update.message.reply_text(notification.message)
                notification.sent = True
            session.commit()
        else:
            await update.message.reply_text("You have no new notifications.")
    finally:
        session.remove()

# Main function to start the bot
def main():
    application = Application.builder().token(TELEGRAM_BOT_TOKEN).build()

    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("join_giveaway", join_giveaway))
    application.add_handler(CommandHandler("notifications", user_notifications))

    # Start polling and checking the database periodically
    job_queue = application.job_queue
    job_queue.run_repeating(lambda context: asyncio.create_task(check_database(application)), interval=10)

    application.initialize()
    application.start()
    application.run_polling()

if __name__ == '__main__':
    asyncio.run(main())
and the join_giveaway page javascript: document.addEventListener('DOMContentLoaded', async () => {
    // Initialize Telegram Web App
    if (window.Telegram && window.Telegram.WebApp) {
        window.Telegram.WebApp.ready();

        const userId = window.Telegram.WebApp.initDataUnsafe?.user?.id;
        if (!userId) {
            alert('User ID is missing. Please open this link in the Telegram app.');
            return;
        }

        localStorage.setItem('user_id', userId);

        // Attempt to extract the giveaway_id from the original URL
        
        const urlParams = new URLSearchParams(window.location.search);
        let giveawayId = urlParams.get('giveaway_id');

        // If not found, attempt to extract it from the Telegram WebApp hash fragment
        if (!giveawayId) {
            const hashParams = new URLSearchParams(window.location.hash.substring(1));
            const tgWebAppData = hashParams.get('tgWebAppData');

            if (tgWebAppData) {
                try {
                    const decodedData = decodeURIComponent(tgWebAppData);
                    const dataParams = new URLSearchParams(decodedData);
                    giveawayId = dataParams.get('giveaway_id');
                } catch (error) {
                    console.error('Error parsing Telegram WebApp data:', error);
                }
            }
        }

        if (!giveawayId) {
            alert('Giveaway ID is missing.');
            return;
        }

        console.log("Giveaway ID:", giveawayId); // Debugging line to verify the ID

        const joinButton = document.getElementById('join-button');
        joinButton.addEventListener('click', async function (event) {
            event.preventDefault(); // Prevent the form from submitting traditionally

            try {
                const response = await fetch('https://backend1-production-29e4.up.railway.app/join_giveaway', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        giveaway_id: giveawayId,
                        telegram_id: userId
                    }),
                });

                const result = await response.json();
                if (result.success) {
                    displayCongratsPopup();
                    setTimeout(() => {
                        window.Telegram.WebApp.close(); // Close the Telegram Web App
                    }, 3000);

                    // Notify the user via the bot
                    await fetch(https://api.telegram.org/bot7514207604:AAE_p_eFFQ3yOoNn-GSvTSjte2l8UEHl7b8/sendMessage, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams({
                            chat_id: userId,
                            text: 'You have successfully joined the giveaway! Good luck!',
                        }),
                    });
                } else {
                    alert('Failed to join the giveaway. Please try again.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            }
        });

        function displayCongratsPopup() {
            const congratsPopup = document.getElementById('congrats-popup');
            congratsPopup.style.display = 'block';
        }
    } else {
        alert('Telegram Web App is not available. Please open this link in the Telegram app.');
    }
});